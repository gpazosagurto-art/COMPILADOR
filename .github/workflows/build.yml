name: Build Windows EXE (zipball fallback)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      onefile:
        description: "Usar --onefile (true/false)"
        default: "false"
        required: true

jobs:
  build:
    runs-on: windows-latest

    steps:
      # --- BYPASS checkout: descargamos el zip del repo en este commit ---
      - name: Download source zipball
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $ref = "${{ github.sha }}"
          $owner = "${{ github.repository_owner }}"
          $repo  = "${{ github.event.repository.name }}"
          $url   = "https://api.github.com/repos/$owner/$repo/zipball/$ref"

          Write-Host "Descargando $url"
          Invoke-WebRequest -Headers @{Authorization="Bearer $env:GH_TOKEN"; "X-GitHub-Api-Version"="2022-11-28"} `
                            -Uri $url -OutFile src.zip
          Expand-Archive src.zip -DestinationPath src -Force
          $root = Get-ChildItem src | Select-Object -First 1
          Copy-Item -Path (Join-Path $root.FullName "*") -Destination . -Recurse -Force

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install deps
        shell: pwsh
        run: |
          python -m pip install --upgrade pip wheel setuptools
          if (Test-Path .\requirements.txt) {
            pip install -r requirements.txt
          } else {
            Write-Host "Sin requirements.txt; continuo con stdlib."
          }
          pip install pyinstaller

      # -------- (Opcional) FFmpeg embebido como en tu ejemplo --------
      # - name: Download FFmpeg (release essentials)
      #   shell: pwsh
      #   run: |
      #     $url = "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip"
      #     Invoke-WebRequest -Uri $url -OutFile ffmpeg.zip
      #     Expand-Archive ffmpeg.zip -DestinationPath ffmpeg_zip -Force
      #     $ff = Get-ChildItem -Path ffmpeg_zip -Recurse -Filter ffmpeg.exe | Select-Object -First 1
      #     if (-not $ff) { throw "ffmpeg.exe no encontrado" }
      #     New-Item -ItemType Directory -Force -Path ffmpeg_root | Out-Null
      #     Copy-Item $ff.FullName -Destination (Join-Path ffmpeg_root "ffmpeg.exe") -Force

      # --- Build con SPEC si existe (recomendado para PySide6/Streamlit/etc.) ---
      - name: Build with SPEC (onedir windowed)
        if: ${{ hashFiles('pyinstaller.spec') != '' }}
        shell: pwsh
        run: |
          pyinstaller --noconfirm --clean --workpath build --distpath dist pyinstaller.spec

      # --- Build CLI si NO hay .spec (elige onefile por input) ---
      - name: Build with CLI (onedir/onefile)
        if: ${{ hashFiles('pyinstaller.spec') == '' }}
        shell: pwsh
        run: |
          $onefile = "${{ github.event.inputs.onefile }}" -eq "true"
          $cmd = @(
            "pyinstaller","--noconfirm","--clean",
            "--workpath","build","--distpath","dist",
            "--windowed",
            "--name","compiler-app"
          )
          if ($onefile) { $cmd += "--onefile" }
          if (Test-Path .\icon.ico) { $cmd += @("--icon","icon.ico") }

          # Si activaste FFmpeg arriba, para embebido (raíz):
          # if (Test-Path .\ffmpeg_root\ffmpeg.exe) {
          #   $ff_root = Resolve-Path .\ffmpeg_root\ffmpeg.exe
          #   $cmd += @("--add-binary","$ff_root;.")
          # }

          # Ajusta aquí el entrypoint (main.py o el tuyo)
          $cmd += "main.py"

          echo "Ejecutando: $($cmd -join ' ')"
          & $cmd

      - name: Show dist tree
        shell: pwsh
        run: |
          Get-ChildItem -Recurse -File dist | Select-Object FullName

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: compiler-app-windows
          path: dist/**
          retention-days: 14
