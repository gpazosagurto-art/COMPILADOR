name: Build Windows EXE

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        # Si vuelve a aparecer el 500, puedes fijar:
        # with:
        #   ref: main
        #   fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'   # igual que tu workflow que funciona

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      # (Opcional) Descargar FFmpeg como en tu ejemplo — descomenta si lo quieres dentro del compilador
      # - name: Download FFmpeg (release essentials)
      #   shell: pwsh
      #   run: |
      #     $url = "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip"
      #     Invoke-WebRequest -Uri $url -OutFile ffmpeg.zip
      #     Expand-Archive ffmpeg.zip -DestinationPath ffmpeg_zip -Force
      #     $ff = Get-ChildItem -Path ffmpeg_zip -Recurse -Filter ffmpeg.exe | Select-Object -First 1
      #     if (-not $ff) { throw "ffmpeg.exe no encontrado" }
      #     New-Item -ItemType Directory -Force -Path ffmpeg_root | Out-Null
      #     Copy-Item $ff.FullName -Destination (Join-Path ffmpeg_root "ffmpeg.exe") -Force

      # A) Si tienes pyinstaller.spec (recomendado para PySide6), úsalo:
      - name: Build (SPEC, windowed onedir)
        if: ${{ hashFiles('pyinstaller.spec') != '' }}
        shell: pwsh
        run: |
          pyinstaller --noconfirm --clean --workpath build --distpath dist pyinstaller.spec

      # B) Si NO hay .spec, usa CLI (windowed onedir). Ajusta nombre del exe si quieres.
      - name: Build (CLI, windowed onedir)
        if: ${{ hashFiles('pyinstaller.spec') == '' }}
        shell: pwsh
        run: |
          $cmd = @(
            "pyinstaller","--noconfirm","--clean",
            "--windowed",
            "--workpath","build",
            "--distpath","dist",
            "--name","compiler-app",
            "main.py"
          )
          if (Test-Path .\icon.ico) { $cmd += @("--icon","icon.ico") }
          # Si activaste FFmpeg arriba, para embebido:
          # if (Test-Path .\ffmpeg_root\ffmpeg.exe) {
          #   $ff = Resolve-Path .\ffmpeg_root\ffmpeg.exe
          #   $cmd += @("--add-binary","$ff;.")
          # }
          echo "Ejecutando: $($cmd -join ' ')"
          & $cmd

      - name: Show dist tree
        shell: pwsh
        run: |
          Get-ChildItem -Recurse -File dist | Select-Object FullName

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: compiler-app-windows
          path: dist/**
